<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />




<title>Introduction to Spatial Data in R: Part I</title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/cosmo.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<script src="site_libs/navigation-1.1/codefolding.js"></script>
<link href="site_libs/highlightjs-9.12.0/textmate.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>



<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>

<link rel="stylesheet" href="styles.css" type="text/css" />



<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 51px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h2 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h3 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h4 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h5 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h6 {
  padding-top: 56px;
  margin-top: -56px;
}
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #ffffff;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  background: white;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->
<style type="text/css">
.code-folding-btn { margin-bottom: 4px; }
</style>



<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}

@media print {
.toc-content {
  /* see https://github.com/w3c/csswg-drafts/issues/4434 */
  float: right;
}
}

.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>



</head>

<body>


<div class="container-fluid main-container">


<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row-fluid">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">GEO 200CN: Winter 2020</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">Home</a>
</li>
<li>
  <a href="syllabus.html">Syllabus</a>
</li>
<li>
  <a href="hw_guidelines.html">Assignment Guidelines</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Labs
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="tidyr.html">Tidy R</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Other
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a></a>
    </li>
  </ul>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div class="fluid-row" id="header">

<div class="btn-group pull-right">
<button type="button" class="btn btn-default btn-xs dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><span>Code</span> <span class="caret"></span></button>
<ul class="dropdown-menu" style="min-width: 50px;">
<li><a id="rmd-show-all-code" href="#">Show All Code</a></li>
<li><a id="rmd-hide-all-code" href="#">Hide All Code</a></li>
</ul>
</div>



<h1 class="title toc-ignore">Introduction to Spatial Data in R: Part I</h1>
<h3 class="subtitle"><h4 style="font-style:normal">
GEO 200CN - Quantitative Geography
</h4></h3>
<h4 class="author"><h4 style="font-style:normal">
Professor Noli Brazil
</h4></h4>
<h4 class="date"><h4 style="font-style:normal">
April 9, 2020
</h4></h4>

</div>


<style>
p.comment {
background-color: #DBDBDB;
padding: 10px;
border: 1px solid black;
margin-left: 25px;
border-radius: 5px;
font-style: italic;
}

.figure {
   margin-top: 20px;
   margin-bottom: 20px;
}

h1.title {
  font-weight: bold;
  font-family: Arial;  
}

h2.title {
  font-family: Arial;  
}

</style>
<style type="text/css">
#TOC {
  font-size: 13px;
  font-family: Arial;
}
</style>
<p><br />
</p>
<p>In the first three labs, we went through the base and tidy approaches to processing <em>nonspatial</em> data in R. In this guide, you will acquire the skills needed to process and present <em>spatial</em> data in R. This lab will focus on vector data. We’ll cover Raster data later in the quarter.</p>
<p>Unsurprisingly, there is more than one way to process spatial data in R. This guide will go through the <strong>sf</strong> package first as it will be the main package for handling spatial data in this class. The other major spatial package that we’ll use is <strong>sp</strong>. We will cover <strong>sp</strong> next week. Packages that deal with other spatial data types will be covered throughout the quarter.</p>
<p>The best references for <strong>sf</strong> and, more broadly, cleaning, managing and analyzing spatial data in R are <a href="https://geocompr.robinlovelace.net/">Geocomputation with R</a> (GWR) and <a href="https://keen-swartz-3146c4.netlify.com/">Spatial Data Science</a> (SDS). The SDS book is complete up through chapter 8. Both are freely available through the links provided.</p>
<div style="margin-bottom:25px;">

</div>
<div id="sf-package" class="section level2">
<h2><strong>sf package</strong></h2>
<p><br />
<strong>sf</strong> stands for simple features. What is a feature? A feature is thought of as a thing, or an object in the real world, such as a building or a tree. A county can be a feature. As can a city and a neighborhood. Features have a geometry describing where on Earth the features are located, and they have attributes, which describe other properties. Think back to our prior lab - we were working with counties. The difference between what we were doing then and what we will be doing in this lab is that counties in the prior lab had attributes (e.g. percent Hispanic, total population), but they did not have geometries. As such, we could not put them on a map because we don’t have their specific geographic coordinates.</p>
<p>Install <strong>sf</strong> if you have not already done so</p>
<pre class="r"><code>install.packages(&quot;sf&quot;)</code></pre>
<p>We will also be using the package <strong>rmapshaper</strong> in this lab.</p>
<pre class="r"><code>install.packages(&quot;rmapshaper&quot;)</code></pre>
<p>Load <strong>sf</strong> and <strong>rmapshaper</strong> using <code>library()</code>. We’ll also be using the package <strong>tidyverse</strong>, so load it up as well.</p>
<pre class="r"><code>library(sf)
library(rmapshaper)
library(tidyverse)</code></pre>
<div style="margin-bottom:25px;">

</div>
</div>
<div id="reading-spatial-data" class="section level2">
<h2><strong>Reading spatial data</strong></h2>
<p><br />
The function for reading in spatial data into R is <code>st_read()</code>. The shapefile is the most commonly used file format for vector data. I zipped up and uploaded onto GitHub a folder containing four shapefiles. Set your working directory to an appropriate folder and use the following code to download and unzip the file.</p>
<pre class="r"><code>setwd(&quot;insert your pathway here&quot;)
download.file(url = &quot;https://raw.githubusercontent.com/geo200cn/data/master/spatialsflab.zip&quot;, destfile = &quot;spatialsflab.zip&quot;)
unzip(zipfile = &quot;spatialsflab.zip&quot;)</code></pre>
<p>Don’t worry if you don’t understand these commands - they are more for you to simply copy and paste so that you can download files that I zipped up and uploaded onto GitHub. You can look at the help documentation for each function if you are curious.</p>
<p>You should see four shapefiles in the folder you specified in <code>setwd()</code>: <em>californiatracts.shp</em>, <em>sacmetroarea.shp</em>, <em>sacramentocity.shp</em>, and <em>city_trees.shp</em>. First, bring in <em>californiatracts.shp</em>, which contains non-Hispanic white and total population for all <a href="https://www2.census.gov/geo/pdfs/education/CensusTracts.pdf">census tracts</a> in California.</p>
<pre class="r"><code>ca.tracts &lt;- st_read(&quot;californiatracts.shp&quot;, stringsAsFactors = FALSE)</code></pre>
<p>The argument <code>stringsAsFactors = FALSE</code> tells R to keep any variables that look like a character as a character and not a factor. Next, bring in <em>sacmetroarea.shp</em>, which contains Sacramento <a href="https://www2.census.gov/geo/pdfs/reference/GARM/Ch13GARM.pdf">metropolitan area</a> boundaries.</p>
<pre class="r"><code>sac.metro &lt;- st_read(&quot;sacmetroarea.shp&quot;, stringsAsFactors = FALSE)</code></pre>
<p>Finally, bring in <em>sacramentocity.shp</em>, which contains Sacramento <a href="https://www.census.gov/content/dam/Census/data/developers/understandingplace.pdf">city</a> boundaries</p>
<pre class="r"><code>sac.city &lt;- st_read(&quot;sacramentocity.shp&quot;, stringsAsFactors = FALSE)</code></pre>
<p>We will bring in <em>city_trees.shp</em> later in the lab.</p>
<p>You can bring in other types of spatial data other than shapefiles. See a list of these file types <a href="https://cran.r-project.org/web/packages/sf/vignettes/sf2.htmls">here</a>.</p>
<div style="margin-bottom:25px;">

</div>
</div>
<div id="data-manipulation" class="section level2">
<h2><strong>Data manipulation</strong></h2>
<p><br />
There is a lot of stuff <a href="https://r-spatial.github.io/sf/articles/sf1.html">behind the curtain</a> of how R handles spatial data as simple features, but the main takeaway is that <strong>sf</strong> objects are data frames. This means you can use many of the functions we’ve learned in the past couple labs to manipulate <strong>sf</strong> objects, and this includes our best buddy the pipe <code>%&gt;%</code> operator. For example, let’s do the following data wrangling tasks on <em>ca.tracts</em>.</p>
<ol style="list-style-type: decimal">
<li>Convert the dataset from long to wide</li>
<li>Create the variable <em>pwh</em> which is the percent of the tract population that is non-Hispanic white</li>
<li>Break up the column <em>NAME</em> into separate tract, county and state variables using the <code>separate()</code> function</li>
</ol>
<p>We do all of this in one line of continuous code using the pipe operator <code>%&gt;%</code></p>
<pre class="r"><code>ca.tracts &lt;- ca.tracts %&gt;%
            spread(key = variable, value = estimate) %&gt;%
            mutate(pwh = nhwhite/tpopr) %&gt;%
            separate(NAME, into = c(&quot;tract&quot;, &quot;county&quot;, &quot;state&quot;), sep=&quot;, &quot;)</code></pre>
<p>The main takeaway: <strong>sf</strong> objects are tidy friendly, so you can use many of the tidy functions you learned in the last lab on these objects to manipulate your data set. This includes the function <code>ggplot()</code>, which we can use to map the data. We’ll go into more detail later on how to use <code>ggplot()</code> for mapping, so for now just type in</p>
<pre class="r"><code>ggplot(ca.tracts) + geom_sf()</code></pre>
<p><img src="spatialsf_files/figure-html/unnamed-chunk-9-1.png" /><!-- --></p>
<p>If you are getting the following error when you map</p>
<pre><code>---
Error in grid.Call(C_textBounds, as.graphicsAnnot(x$label), x$x, x$y,  : 
  polygon edge not found
---</code></pre>
<p>rerun the code. Keep rerunning it until the error does not come up. This is an <a href="https://github.com/tidyverse/ggplot2/issues/2252">internal issue</a> that has not been resolved. If you are getting an error about R not being able to find the function <code>geom_sf()</code> see <a href="https://stackoverflow.com/questions/46817128/error-could-not-find-function-geom-sf?rq=1">here</a> for some guidance.</p>
<div style="margin-bottom:25px;">

</div>
</div>
<div id="spatial-data-manipulation" class="section level2">
<h2><strong>Spatial data manipulation</strong></h2>
<p><br />
The <strong>sf</strong> package offers a suite of functions unique to managing and transforming spatial data. Most of these functions start out with the prefix <code>st_</code>. The main umbrella function is <code>st_join()</code>.</p>
<p>We won’t go through all of the functions as the list is quite extensive. But, let’s go through the relevant ones for this class.</p>
<div style="margin-bottom:25px;">

</div>
<div id="intersect-and-disjoint" class="section level3">
<h3><strong>Intersect and Disjoint</strong></h3>
<p><br />
A common spatial data wrangling issue is to subset a set of spatial objects based on their location relative to another spatial object. In our case, we want to keep California tracts that are in the Sacramento metro area. Think of what were doing here as something similar to taking a cookie cutter shaped like the Sacramento metro area (in our case, the <strong>sf</strong> object <em>sac.metro</em>) and cutting out the metro area from our cookie dough of census tracts (<em>ca.tracts</em>). We can do this using the <code>join = st_intersects</code> argument within the<code>st_join()</code> function.</p>
<pre class="r"><code>sac.metro.tracts.int &lt;- st_join(x = ca.tracts, y = sac.metro, 
                               join = st_intersects, left=FALSE)</code></pre>
<p>The above code tells R to identify the polygons in <em>ca.tracts</em> that intersect with the polygon <em>sac.metro</em>. We indicate we want a polygon intersection by specifying <code>join = st_intersects</code>. The option <code>left=FALSE</code> tells R to eliminate the polygons from <em>ca.tracts</em> that do not intersect (make it <code>TRUE</code> and see what happens).</p>
<p>Mapping the Sacramento metropolitan area boundary <em>sac.metro</em> that we downloaded and filtered earlier onto these cut out tracts, we get</p>
<pre class="r"><code>ggplot() + 
  geom_sf(data = sac.metro.tracts.int, fill = &quot;blue&quot;) +
  geom_sf(data = sac.metro, fill = NA, color = &quot;red&quot;)</code></pre>
<p><img src="spatialsf_files/figure-html/unnamed-chunk-11-1.png" /><!-- --></p>
<p>The code we ran above returns all tracts that <strong>intersect</strong> or <strong>touch</strong> <em>sac.metro</em>, which include those that <strong>touch</strong> the metro’s boundary. So, we have tracts that are not actually inside the metro area boundaries but touch them.</p>
<p>The opposite of <code>st_intersects</code> is <code>st_disjoint</code>. If two geometries are disjoint, they do not intersect, and vice-versa.</p>
<pre class="r"><code>sac.metro.tracts.dis &lt;- st_join(x = ca.tracts, y = sac.metro, 
                               join = st_disjoint, left=FALSE)</code></pre>
<pre class="r"><code>ggplot() + 
  geom_sf(data = sac.metro.tracts.dis, fill = &quot;blue&quot;) +
  geom_sf(data = sac.metro, fill = NA, color = &quot;red&quot;)</code></pre>
<p><img src="spatialsf_files/figure-html/unnamed-chunk-13-1.png" /><!-- --></p>
<div style="margin-bottom:25px;">

</div>
</div>
<div id="within-and-overlap" class="section level3">
<h3><strong>Within and Overlap</strong></h3>
<p><br />
As we saw above, <code>st_intersects()</code> returns tracts that touch the Sacramento metropolitan area. We can use <code>join = st_within()</code> to return tracts that are completely <em>within</em> the metro.</p>
<pre class="r"><code># subset ca.tracts to those in sac.metro
sac.metro.tracts.w &lt;- st_join(ca.tracts, sac.metro, join = st_within, left=FALSE)

ggplot() + 
    geom_sf(data = sac.metro.tracts.w, fill = &quot;blue&quot;) +
    geom_sf(data = sac.metro, fill = NA, color = &quot;red&quot;)</code></pre>
<p><img src="spatialsf_files/figure-html/unnamed-chunk-14-1.png" /><!-- --></p>
<p>Perfect, this is what we wanted in the first place.</p>
<p>If you look at the at <em>sac.metro.tracts.w</em>’s attribute table, you’ll see it includes all the variables from both <em>ca.tracts</em> and <em>sac.metro</em>. We don’t need all of these variables, so use <code>select()</code> to filter them out. You’ll also notice that if variables from different data objects being joined together share the same name, <code>st_join()</code> (and <code>left_join()</code>) will keep both and attach a <em>.x</em> and <em>.y</em> to the end. For example, <em>GEOID</em> was found in both <em>ca.tracts</em> and <em>sac.metro</em>, so R named one <em>GEOID.x</em> and the other that was merged in was named <em>GEOID.y</em>.</p>
<pre class="r"><code>names(sac.metro.tracts.w)</code></pre>
<pre><code>##  [1] &quot;GEOID.x&quot;  &quot;tract&quot;    &quot;county&quot;   &quot;state&quot;    &quot;nhwhite&quot;  &quot;tpopr&quot;   
##  [7] &quot;pwh&quot;      &quot;CSAFP&quot;    &quot;CBSAFP&quot;   &quot;AFFGEOID&quot; &quot;GEOID.y&quot;  &quot;NAME&quot;    
## [13] &quot;LSAD&quot;     &quot;ALAND&quot;    &quot;AWATER&quot;   &quot;geometry&quot;</code></pre>
<p>Keep the necessary variables and rename <em>GEOID.x</em> back to <em>GEOID</em>.</p>
<pre class="r"><code>sac.metro.tracts.w &lt;- sac.metro.tracts.w %&gt;%
      select(GEOID.x:pwh) %&gt;%
      rename(GEOID = &quot;GEOID.x&quot;)</code></pre>
<p>The opposite of <code>st_within</code> is <code>st_overlaps</code>. Because tracts are completely nested within the Sacramento metropolitan area, you should get nothing in return when using <code>st_overlaps</code></p>
<pre class="r"><code># subset ca.tracts to those in sac.metro
sac.metro.tracts.o &lt;- st_join(ca.tracts, sac.metro, join = st_overlaps, left=FALSE)

ggplot() + 
    geom_sf(data = sac.metro.tracts.o, fill = &quot;blue&quot;) +
    geom_sf(data = sac.metro, fill = NA, color = &quot;red&quot;)</code></pre>
<p><img src="spatialsf_files/figure-html/unnamed-chunk-17-1.png" /><!-- --></p>
<p>This is not the case if you look at Sacramento city, where tracts overlap city boundaries. Compare <code>st_within</code> and <code>st_overlap</code> using <em>sac.city</em></p>
<pre class="r"><code># subset ca.tracts to those in sac.metro
sac.city.tracts.w &lt;- st_join(ca.tracts, sac.city, join = st_within, left=FALSE)

sac.city.tracts.o &lt;- st_join(ca.tracts, sac.city, join = st_overlaps, left=FALSE)</code></pre>
<p>First, within</p>
<pre class="r"><code>ggplot() + 
    geom_sf(data = sac.city.tracts.w, fill = &quot;blue&quot;) +
    geom_sf(data = sac.city, fill = NA, color = &quot;red&quot;)</code></pre>
<p><img src="spatialsf_files/figure-html/unnamed-chunk-19-1.png" /><!-- --></p>
<p>Next overlaps</p>
<pre class="r"><code>ggplot() + 
    geom_sf(data = sac.city.tracts.o, fill = &quot;blue&quot;) +
    geom_sf(data = sac.city, fill = NA, color = &quot;red&quot;)</code></pre>
<p><img src="spatialsf_files/figure-html/unnamed-chunk-20-1.png" /><!-- --></p>
<div style="margin-bottom:25px;">

</div>
</div>
<div id="clipping" class="section level3">
<h3><strong>Clipping</strong></h3>
<p><br />
Census tracts neatly fall within a metropolitan area’s boundary. In other words, tracts don’t spill over. But, as we see in the above two maps, tracts spill over city boundaries. What if you wanted to just keep the portion of overlapping tracts that is in the city? You would clip the tract. There is no clipping feature within the <code>st_join</code> function. We use the function <code>ms_clip()</code> which is in the <a href="https://cran.r-project.org/web/packages/rmapshaper/rmapshaper.pdf"><strong>rmapshaper</strong></a> package.</p>
<p>Because spatial data are not always precise, when you clip you’ll sometimes get unwanted <a href="https://desktop.arcgis.com/en/arcmap/latest/manage-data/editing-fundamentals/removing-slivers-or-gaps-between-polygons.htm">sliver polygons</a>.</p>
<pre class="r"><code>sac.city.tracts.c &lt;- ms_clip(target = ca.tracts, clip = sac.city, remove_slivers = TRUE)</code></pre>
<p>The argument <code>remove_slivers = TRUE</code> removes these slivers.</p>
<pre class="r"><code>ggplot() + 
    geom_sf(data = sac.city.tracts.c, fill = &quot;blue&quot;) +
    geom_sf(data = sac.city, fill = NA, color = &quot;red&quot;)</code></pre>
<p><img src="spatialsf_files/figure-html/unnamed-chunk-22-1.png" /><!-- --></p>
<p>The <strong>sf</strong> package has a number of other <code>st_</code> functions both within the <code>st_join()</code> function and separately. In addition to GWR, check out <a href="https://keen-swartz-3146c4.netlify.com/geommanip.html">Chapter 5</a> in SDS to learn more.</p>
<div style="margin-bottom:25px;">

</div>
</div>
<div id="aggregate" class="section level3">
<h3><strong>Aggregate</strong></h3>
<p><br />
Spatial aggregation involves either summing up the number or the attribute values of geometric features located within another geometric feature. In the tidyverse, this is easily done by using the <code>summarize()</code> function.</p>
<p>For example, let’s say we wanted to add the total population within the 58 counties in California using census tract data. We have the variable <em>county</em> that we created above that identifies the county that each tract resides in.</p>
<pre class="r"><code>counties = ca.tracts %&gt;% group_by(county) %&gt;%
  summarize(pop = sum(tpopr, na.rm = TRUE))</code></pre>
<p>You’ll notice that the data frame <em>counties</em> contains 58 counties. What is going on in terms of the geometries? Behind the scenes, <code>summarize()</code> combines the geometries and dissolve the boundaries between them using the function <code>st_union()</code>.</p>
<p>You can also add up the number of features within a polygon. This is known as a points in polygon operation. To illustrate this operation, bring in the shapefile <em>city_trees.shp</em>, which contains tree site locations maintained by the Urban Forestry section of the Department of Public Works downloaded from the <a href="https://data.cityofsacramento.org/datasets/b9b716e09b5048179ab648bb4518452b_0">City of Sacramento Open Data GIS Portal</a>.</p>
<pre class="r"><code>trees &lt;- st_read(&quot;city_trees.shp&quot;, stringsAsFactors = FALSE)</code></pre>
<p>We combine the functions <code>st_join()</code> and <code>summarize()</code> to get the number of trees located in each Sacramento city census tract. You use <code>group_by()</code> to group by the variable that uniquely identifies the census tracts, in our case <em>GEOID</em>. This operation might take a few minutes because there are over 97,000 city maintained trees in the city!!</p>
<pre class="r"><code>sac.tract.trees &lt;- sac.city.tracts.c %&gt;% 
      st_join(trees) %&gt;%
      group_by(GEOID) %&gt;% 
      summarize(n_trees = n()) </code></pre>
<div style="margin-bottom:25px;">

</div>
</div>
</div>
<div id="writing-data" class="section level2">
<h2><strong>Writing data</strong></h2>
<p> </p>
<p>Earlier you learned how to read in spatial data. We end today’s lab by learning how to write spatial data. The function is <code>st_write()</code>.</p>
<p>Let’s save the Sacramento city tract data frame containing the number of trees located in each tract.</p>
<pre class="r"><code>st_write(sac.tract.trees, &quot;Sacramento_Tract_Trees.shp&quot;, delete_layer = TRUE)</code></pre>
<p>The <code>delete_layer = TRUE</code> argument tells R to overwrite the file <em>Sacramento_Tract_Trees.shp</em> if it already exists in your current directory.</p>
<p>You’ve completed your introduction to <strong>sf</strong>.</p>
<p>Badge? Yes, please.</p>
<center>
<div class="figure">
<img src="sf.gif" style="width:25.0%" />

</div>
</center>
<p><br />
</p>
<hr />
<p>Website created and maintained by <a href="https://nbrazil.faculty.ucdavis.edu/">Noli Brazil</a></p>
</div>



</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open')
  });
});
</script>

<!-- code folding -->
<script>
$(document).ready(function () {
  window.initializeCodeFolding("show" === "show");
});
</script>

<script>
$(document).ready(function ()  {

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_').toLowerCase();
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>


</body>
</html>
