<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />


<meta name="author" content="Professor Noli Brazil" />

<meta name="date" content="2024-05-13" />

<title>Spatial Regression</title>

<script src="site_libs/header-attrs-2.22/header-attrs.js"></script>
<script src="site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/cosmo.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/jqueryui-1.13.2/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<script src="site_libs/navigation-1.1/codefolding.js"></script>
<link href="site_libs/highlightjs-9.12.0/textmate.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
      .display.math{display: block; text-align: center; margin: 0.5rem auto;}
  </style>

<style type="text/css">code{white-space: pre;}</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>






<link rel="stylesheet" href="styles.css" type="text/css" />



<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
details > summary > p:only-child {
  display: inline;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark the anchor link active (and if it's in a dropdown, also mark that active)
  var dropdown = menuAnchor.closest('li.dropdown');
  if (window.bootstrap) { // Bootstrap 4+
    menuAnchor.addClass('active');
    dropdown.find('> .dropdown-toggle').addClass('active');
  } else { // Bootstrap 3
    menuAnchor.parent().addClass('active');
    dropdown.addClass('active');
  }

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before, .tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "\e259";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "\e258";
  font-family: 'Glyphicons Halflings';
  border: none;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->
<style type="text/css">
.code-folding-btn { margin-bottom: 4px; }
</style>



<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}

@media print {
.toc-content {
  /* see https://github.com/w3c/csswg-drafts/issues/4434 */
  float: right;
}
}

.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>



</head>

<body>


<div class="container-fluid main-container">


<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-bs-toggle="collapse" data-target="#navbar" data-bs-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">GEO 200CN: Spring 2024</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">Home</a>
</li>
<li>
  <a href="syllabus.html">Syllabus</a>
</li>
<li>
  <a href="hw_guidelines.html">Assignment Guidelines</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Labs
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="getting_started.html">Getting Started</a>
    </li>
    <li>
      <a href="eda.html">Exploratory Data Analysis</a>
    </li>
    <li>
      <a href="inference.html">Statistical Inference</a>
    </li>
    <li>
      <a href="hypothesis.html">Hypothesis Testing</a>
    </li>
    <li>
      <a href="linearregression.html">Linear Regression</a>
    </li>
    <li>
      <a href="linearregression2.html">More Linear Regression</a>
    </li>
    <li>
      <a href="logistic.html">Logistic Regression</a>
    </li>
    <li>
      <a href="introspatial.html">Intro to Spatial Data</a>
    </li>
    <li>
      <a href="pointpatterns.html">Point Pattern Analysis</a>
    </li>
    <li>
      <a href="spatialautocorrelation.html">Spatial Autocorrelation</a>
    </li>
    <li>
      <a href="spatialreg.html">Spatial Regression</a>
    </li>
    <li>
      <a href="prediction.html">Prediction Modelling</a>
    </li>
    <li>
      <a href="variableselection.html">Variable Selection</a>
    </li>
    <li>
      <a href="interpolation.html">Spatial Interpolation</a>
    </li>
    <li>
      <a href="kriging.html">Kriging</a>
    </li>
    <li>
      <a href="regtrees.html">Regression Trees</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Other
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="tips.html">R Tips</a>
    </li>
    <li>
      <a href="data_wrangling.html">Data Wrangling</a>
    </li>
  </ul>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">

<div class="btn-group pull-right float-right">
<button type="button" class="btn btn-default btn-xs btn-secondary btn-sm dropdown-toggle" data-toggle="dropdown" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><span>Code</span> <span class="caret"></span></button>
<ul class="dropdown-menu dropdown-menu-right" style="min-width: 50px;">
<li><a id="rmd-show-all-code" href="#">Show All Code</a></li>
<li><a id="rmd-hide-all-code" href="#">Hide All Code</a></li>
</ul>
</div>



<h1 class="title toc-ignore">Spatial Regression</h1>
<h3 class="subtitle"><font size="4">GEO 200CN - Quantitative
Geography</font></h3>
<h4 class="author">Professor Noli Brazil</h4>
<h4 class="date">May 13, 2024</h4>

</div>


<style>
p.comment {
background-color: #DBDBDB;
padding: 10px;
border: 1px solid black;
margin-left: 25px;
border-radius: 5px;
font-style: normal;
}

.figure {
   margin-top: 20px;
   margin-bottom: 20px;
}

h1.title {
  font-weight: bold;
  font-family: Arial;  
}

h2.title {
  font-family: Arial;  
}

</style>
<style type="text/css">
#TOC {
  font-size: 13px;
  font-family: Arial;
}
</style>
<p><br />
</p>
<p>In this lab guide, we formally incorporate spatial dependency between
units of observations in a regression framework. We will be closely
following this week’s handout on Spatial Regression. The objectives of
this lab are as follows</p>
<ol style="list-style-type: decimal">
<li>Learn how to run and interpret a spatial lag model</li>
<li>Learn how to run and interpret a spatial error model</li>
<li>Learn how to decide between a standard linear regression, spatial
lag, and spatial error model.</li>
</ol>
<p>To help us accomplish these learning objectives, we will examine the
association between neighborhood characteristics and COVID-19 case rates
in New York City zip codes. New York City was the <a
href="https://www.cdc.gov/mmwr/volumes/69/wr/mm6946a2.htm">epicenter of
the initial COVID-19 outbreak in the United States</a>. We will examine
whether there are disparities in the types of neighborhoods that were
first hit the hardest in the city.</p>
<div style="margin-bottom:25px;">

</div>
<div id="installing-and-loading-packages" class="section level2">
<h2><strong>Installing and loading packages</strong></h2>
<p><br />
</p>
<p>We’ll be using one new package in this lab,
<strong>spatialreg</strong>, which contains the functions we need to
perform spatial regression models in R. First, install the package if
you have not already done so.</p>
<pre class="r"><code>install.packages(&quot;spatialreg&quot;)</code></pre>
<p>Then load it and the other packages we’ll be using in this lab.</p>
<pre class="r"><code>library(tidyverse)
library(sf)
library(spdep)
library(tmap)
library(spatialreg)</code></pre>
<div style="margin-bottom:25px;">

</div>
</div>
<div id="why-run-a-spatial-regression" class="section level2">
<h2><strong>Why run a spatial regression</strong></h2>
<p><br />
</p>
<p>The reasons why you run a spatial regression significantly overlap
with the reasons for <a
href="https://geo200cn.github.io/linearregression.html#Why_linear_regression">running
a regular linear regression</a>. However, there is one additional
important motivation: to explicitly incorporate spatial dependency in
the model. There are two common flavors of spatial regression: the
spatial error model (SEM) and the spatial lag model (SLM). The main
reason to run a spatial error model is to control for general spatial
autocorrelation. We want to do this because spatial autocorrelation
breaks the very important assumption that our regression errors are not
correlated. The main reason to run a spatial lag model is to formally
model spatial contagion. We are modelling the impact of our neighbors’
outcomes on our own outcome. For example, the impact of nearby crime on
neighborhood crime. Or the impact of a plot’s crop yield on its
neighboring plot’s yield.</p>
<p>So, in one case, we are using spatial regression because we see
spatial dependency as a nuisance to control for. In the other case, we
are using spatial regression because there is substantive interest in
formally examining the impact of neighboring areas.</p>
<p>Our research questions in this lab is: What ecological
characteristics are associated with zip code COVID-19 case rates in New
York City? Do these relationships change after accounting for unobserved
spatial dependency? Do nearby COVID-19 rates influence the rates in a
neighborhood?</p>
<div style="margin-bottom:25px;">

</div>
</div>
<div id="bringing-in-the-data" class="section level2">
<h2><strong>Bringing in the data</strong></h2>
<p><br />
</p>
<p>We will bring in a shape file containing COVID-19 cases per 1,000
residents and demographic and socioeconomic characteristics for New York
city zip codes. I zipped up the file and uploaded it onto Github. Set
your working directory to an appropriate folder and use the following
code to download and unzip the file.</p>
<pre class="r"><code>#insert the pathway to the folder you want your data stored into
setwd(&quot;insert your pathway here&quot;)
#downloads file into your working directory 
download.file(url = &quot;https://raw.githubusercontent.com/geo200cn/data/master/zctanyccovidwk7.zip&quot;, destfile = &quot;zctanyccovidwk7.zip&quot;)
#unzips the zipped file
unzip(zipfile = &quot;zctanyccovidwk7.zip&quot;)</code></pre>
<p>Bring in the New York City zip code shape file into R using
<code>st_read()</code></p>
<pre class="r"><code>zctanyc &lt;- st_read(&quot;zctanyccovidwk7.shp&quot;)</code></pre>
<p>COVID-19 case data were downloaded from the <a
href="https://github.com/nychealth/coronavirus-data">NYC Department of
Health and Mental Hygiene</a> (confirmed cases up through May 1, 2020).
Socioeconomic and demographic data were downloaded from the 2014-2018 <a
href="https://www.census.gov/programs-surveys/acs">American Community
Survey</a>. A record layout of the data can be found <a
href="https://raw.githubusercontent.com/geo200cn/data/master/zctanyccovidRL.txt">here</a>.</p>
<div style="margin-bottom:25px;">

</div>
</div>
<div id="basic-multiple-linear-regression" class="section level2">
<h2><strong>Basic multiple linear regression</strong></h2>
<p><br />
</p>
<p>We’re interested in examining the zip code characteristics associated
with the number of COVID-19 cases per 1,000 residents. We should first
run through the various exploratory data analysis tools we went through
<a href="https://geo200cn.github.io/eda.html">several weeks ago</a> to
get a feel for the data. We would then run a standard multiple linear
regression model, which we should always do first before running any
type of spatial regression model. Our dependent variable is
<em>covidrate</em> and our independent variables are percent black
<em>pblk</em>, percent Hispanic <em>phisp</em>, median household income
<em>medincome</em>, total population <em>totp</em>, and percent of
residents 65 years old and older <em>p65old</em>. Use the function
<code>lm()</code>. Save the results in an object named
<em>fit.ols</em>.</p>
<pre class="r"><code>#eliminate scientific notation
options(scipen=999)

fit.ols &lt;- lm(covidrate ~  pblk + phisp +  medincome +totp + p65old, 
              data = zctanyc)</code></pre>
<p>What are the results? Use <code>summary()</code></p>
<pre class="r"><code>summary(fit.ols)</code></pre>
<pre><code>## 
## Call:
## lm(formula = covidrate ~ pblk + phisp + medincome + totp + p65old, 
##     data = zctanyc)
## 
## Residuals:
##      Min       1Q   Median       3Q      Max 
## -10.5625  -4.2955  -0.8762   3.7455  15.4670 
## 
## Coefficients:
##                Estimate  Std. Error t value  Pr(&gt;|t|)    
## (Intercept) 12.57451167  3.21496495   3.911  0.000132 ***
## pblk         0.09056056  0.02013347   4.498 0.0000126 ***
## phisp        0.12825817  0.03007490   4.265 0.0000331 ***
## medincome   -0.00004588  0.00001737  -2.642  0.009012 ** 
## totp        -0.00004357  0.00001757  -2.480  0.014097 *  
## p65old       0.36634418  0.09276337   3.949  0.000114 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 5.48 on 171 degrees of freedom
## Multiple R-squared:  0.3767, Adjusted R-squared:  0.3585 
## F-statistic: 20.67 on 5 and 171 DF,  p-value: 0.0000000000000004017</code></pre>
<p>After running the standard linear regression model, use the various
diagnostic tools we learned <a
href="https://geo200cn.github.io/linearregression2.html">in the second
linear regression lab</a> to test for the OLS assumptions and detect for
multicollinearity.</p>
<div style="margin-bottom:25px;">

</div>
</div>
<div id="exploratory-spatial-data-analysis" class="section level2">
<h2><strong>Exploratory spatial data analysis</strong></h2>
<p><br />
</p>
<p>The next step is to conduct an Exploratory Spatial Data Analysis
(ESDA) to gain an understanding of how your data are spatially
structured. Perhaps there is no spatial dependency present in your data.
So, why fancy it up if when you don’t need to?</p>
<div style="margin-bottom:25px;">

</div>
<div id="map-your-data" class="section level3">
<h3><strong>Map your data</strong></h3>
<p><br />
</p>
<p>The first step in ESDA is to map your dependent variable. Map the
COVID-19 case rates</p>
<pre class="r"><code>tm_shape(zctanyc, unit = &quot;mi&quot;) +
  tm_polygons(col = &quot;covidrate&quot;, style = &quot;quantile&quot;,palette = &quot;Blues&quot;, 
              border.alpha = 0, title = &quot;&quot;) +
  tm_scale_bar(breaks = c(0, 2.5, 5), text.size = 1, position = c(&quot;right&quot;, &quot;bottom&quot;)) +
  tm_layout(main.title = &quot;COVID-19 cases per 1,000 residents by NYC zip codes&quot;,  main.title.size = 0.95, frame = FALSE, legend.outside = TRUE)</code></pre>
<p><img
src="spatialreg_files/figure-html/unnamed-chunk-8-1.png" /><!-- --></p>
<p>Does it look like our dependent variable exhibits spatial
autocorrelation?</p>
<p>Next, you’ll want to map the residuals from your OLS regression
model. To extract the residuals from <em>fit.ols</em>, use the
<code>resid()</code> function. Save it back into <em>zctanyc</em>.</p>
<pre class="r"><code>zctanyc &lt;- zctanyc %&gt;%
            mutate(olsresid = resid(fit.ols))</code></pre>
<p>Next, map the residuals</p>
<pre class="r"><code>tm_shape(zctanyc, unit = &quot;mi&quot;) +
  tm_polygons(col = &quot;olsresid&quot;, style = &quot;quantile&quot;,palette = &quot;Reds&quot;, 
              border.alpha = 0, title = &quot;&quot;, midpoint = 0) +
  tm_scale_bar(breaks = c(0, 2.5, 5), text.size = 1, position = c(&quot;right&quot;, &quot;bottom&quot;)) +
  tm_layout(main.title = &quot;Residuals from linear regression&quot;,  main.title.size = 0.95, frame = FALSE, legend.outside = TRUE)</code></pre>
<p><img
src="spatialreg_files/figure-html/unnamed-chunk-10-1.png" /><!-- --></p>
<p>Looks spatially clustered. But we’ll formally test it next.</p>
<div style="margin-bottom:25px;">

</div>
</div>
<div id="spatial-weights-matrix" class="section level3">
<h3><strong>Spatial weights matrix</strong></h3>
<p><br />
</p>
<p>The exploratory maps show signs of spatial dependency. Rather than
eyeballing it, let’s formally test it using a measure of spatial
autocorrelation. Fortunately, we already know how to measure spatial
autocorrelation thanks to a <a
href="https://geo200cn.github.io/spatialautocorrelation.html">previous
lab</a>.</p>
<p>We need to create a neighbor object and its associated spatial
weights matrix. You need to define</p>
<ol style="list-style-type: decimal">
<li>Neighbor connectivity (who is you neighbor?)</li>
<li>Neighbor weights (how much does your neighbor matter?)</li>
</ol>
<p>Neighbor relationships in R are represented by neighbor <em>nb</em>
objects. An <em>nb</em> object identifies the neighbors for each feature
in the dataset. We use the command <code>poly2nb()</code> from the
<strong>spdep</strong> package to create a contiguity-based neighbor
object. Let’s specify Queen connectivity.</p>
<pre class="r"><code>nycb&lt;-poly2nb(zctanyc, queen=T)</code></pre>
<p>The other two neighbor types we discussed in the spatial
autocorrelation lab include <a
href="https://geo200cn.github.io/spatialautocorrelation.html#Neighbor_connectivity:_k-nearest_neighbors">k-nearest
neighbor</a> and <a
href="https://geo200cn.github.io/spatialautocorrelation.html#Neighbor_connectivity:_Distance">distance
based neighbor</a>.</p>
<p>The next step is to assign weights to each neighbor relationship. The
weight determines <em>how much</em> each neighbor counts. You will need
to employ the <code>nb2listw()</code> command. Let’s create a weights
object <em>nycw</em> for our Queen contiguity defined neighbor object
<em>nycb</em>. We might have zero neighbor zip codes, so include the
<code>zero.policy = TRUE</code> argument.</p>
<pre class="r"><code>nycw&lt;-nb2listw(nycb, style=&quot;W&quot;, zero.policy = TRUE)</code></pre>
<p>Here, style = “W” indicates that the weights for each spatial unit
are standardized to sum to 1 (this is known as row standardization).</p>
<div style="margin-bottom:25px;">

</div>
</div>
<div id="moran-scatterplot" class="section level3">
<h3><strong>Moran Scatterplot</strong></h3>
<p><br />
</p>
<p>We’ve now defined what we mean by neighbor by creating an <em>nb</em>
object and the influence of each neighbor by creating a spatial weights
matrix. Now we can examine the Moran scatter plot for the dependent
variable <em>covidrate</em>.</p>
<pre class="r"><code>moran.plot(zctanyc$covidrate, listw=nycw, xlab=&quot;Standardized COVID-19 Case Rate&quot;, 
           ylab=&quot;Standardized Lagged COVID-19 Case Rate&quot;, 
           main=c(&quot;Moran Scatterplot for COVID-19 case rates&quot;, &quot;in New York&quot;),
           zero.policy = TRUE )</code></pre>
<p><img
src="spatialreg_files/figure-html/unnamed-chunk-13-1.png" /><!-- --></p>
<p>Does it look like there is an association? Yes.</p>
<div style="margin-bottom:25px;">

</div>
</div>
<div id="spatial-autocorrelation" class="section level3">
<h3><strong>Spatial autocorrelation</strong></h3>
<p><br />
</p>
<p>The map and Moran scatter plot provide descriptive visualizations of
clustering (autocorrelation) in COVID-19 case rates. But, rather than
eyeballing the correlation, we can calculate a global index of spatial
autocorrelation, and attach statistical significance to it.</p>
<p>The most popular test of spatial autocorrelation is the Global
Moran’s I test. We’ll use the command <code>moran.mc()</code> in the
<strong>spdep</strong> package to calculate the Moran’s I using Monte
Carlo simulation to obtain statistical inference.</p>
<p><br></p>
<p class="comment">
<strong>Question 1</strong>: Calculate the Global Moran’s I for the
outcome variable using 999 Monte Carlo simulations. Is the outcome
spatially autocorrelated?
</p>
<p>We should also test spatial autocorrelation in the residuals. Use the
<code>lm.morantest()</code> function on the linear regression model
<em>fit.ols</em>.</p>
<p class="comment">
<strong>Question 2</strong>: Calculate the Global Moran’s I for the
residuals. Are the residuals spatially autocorrelated?
</p>
<p>If spatial autocorrelation is detected, that does not mean we should
automatically run a spatial regression model. There are other modelling
approaches to dealing with spatial dependency.</p>
<p class="comment">
<strong>Question 3</strong>: Could the inclusion of NYC borough dummy
variables assist in reducing residual spatial dependence? Include in the
OLS model the variable <em>borough</em>, and calculate the Global
Moran’s I for the residuals. Are the residuals spatially autocorrelated?
</p>
<p><br></p>
<div style="margin-bottom:25px;">

</div>
</div>
</div>
<div id="spatial-lag-model" class="section level2">
<h2><strong>Spatial lag model</strong></h2>
<p><br />
</p>
<p>Based on the exploratory mapping, Moran scatter plot, and the Moran’s
I, there appears to be spatial autocorrelation in the dependent
variable. This means that if there is a spatial dependency process going
on and we fit an OLS model our coefficients will be biased and
inefficient. That is, the coefficient size and sign are not close to
their true value and its standard errors are underestimated.</p>
<p>A spatial lag model (SLM) can be estimated in R using the command
<code>lagsarlm()</code>, which is in the <strong>spatialreg</strong>
package. Fit the SLM</p>
<pre class="r"><code>fit.lag&lt;-lagsarlm(covidrate ~  pblk + phisp +  medincome +totp + p65old, 
                  data = zctanyc, 
                  listw = nycw, 
                  zero.policy=TRUE) </code></pre>
<p>The only difference between the code for <code>lm()</code> and
<code>lagsarlm()</code> is the argument <code>listw</code>, which you
use to specify the spatial weights matrix. We specify
<code>zero.policy=TRUE</code> to eliminate zero neighbor zip codes. Also
note that <code>lm()</code> uses OLS to estimate the model whereas
<code>lagsarlm()</code> uses <a
href="https://online.stat.psu.edu/stat415/lesson/1/1.2">Maximum
Likelihood Estimation</a>.</p>
<p>Let’s calculate the Global Moran’s I on the model’s residuals.</p>
<pre class="r"><code>moran.mc(resid(fit.lag), nycw, nsim=999, zero.policy=TRUE)</code></pre>
<pre><code>## 
##  Monte-Carlo simulation of Moran I
## 
## data:  resid(fit.lag) 
## weights: nycw  
## number of simulations + 1: 1000 
## 
## statistic = 0.023944, observed rank = 736, p-value = 0.264
## alternative hypothesis: greater</code></pre>
<p>A summary of results.</p>
<pre class="r"><code>summary(fit.lag)</code></pre>
<pre><code>## 
## Call:lagsarlm(formula = covidrate ~ pblk + phisp + medincome + totp + 
##     p65old, data = zctanyc, listw = nycw, zero.policy = TRUE)
## 
## Residuals:
##      Min       1Q   Median       3Q      Max 
## -7.70893 -2.21115 -0.51621  2.03252 12.76569 
## 
## Type: lag 
## Regions with no neighbours included:
##  59 
## Coefficients: (asymptotic standard errors) 
##                 Estimate   Std. Error z value Pr(&gt;|z|)
## (Intercept)  2.181482601  2.056079156  1.0610 0.288694
## pblk         0.040057708  0.013213379  3.0316 0.002433
## phisp        0.062861581  0.020085387  3.1297 0.001750
## medincome   -0.000014023  0.000010870 -1.2900 0.197057
## totp        -0.000023471  0.000010986 -2.1365 0.032641
## p65old       0.186119527  0.059389122  3.1339 0.001725
## 
## Rho: 0.70864, LR test value: 132.91, p-value: &lt; 0.000000000000000222
## Asymptotic standard error: 0.046717
##     z-value: 15.169, p-value: &lt; 0.000000000000000222
## Wald statistic: 230.09, p-value: &lt; 0.000000000000000222
## 
## Log likelihood: -482.7463 for lag model
## ML residual variance (sigma squared): 11.661, (sigma: 3.4148)
## Number of observations: 177 
## Number of parameters estimated: 8 
## AIC: 981.49, (AIC for lm: 1112.4)
## LM test for residual autocorrelation
## test value: 0.54636, p-value: 0.45981</code></pre>
<p>The results are formatted in a similar way as the OLS results. The
major difference is the inclusion of the results for the spatial lag
coefficient labelled “Rho”. R provides different ways to test the
statistical significance of Rho depending on the null distribution.
Right next to Rho, R shows the LR test value and its associated p-value.
Likelihood ratio (LR) test shows if the addition of the lag is an
improvement (from linear regression) and if that’s significant. Below
Rho is its standard error, and right below that is the test statistic
“z-value” and its associated p-value, which are based on the standard
normal distribution. R also shows the Wald statistic and its associated
p-value. The Wald test examines if the new parameter (the lag) should be
included it in the model. If significant then the new variable improves
the model fit and needs to be included. At the bottom, R also shows the
LM test. Lagrange Multiplier (LM) is a test for the absence of spatial
autocorrelation in the lag model residuals. If significant then you can
reject the Null (no spatial autocorrelation). To be clear, all are
basically testing the statistical significance of the spatial lag
term.</p>
<p>As described in the handout, we’ll need to estimate the direct and
indirect effects to get the total effects of each variable on the
outcome in a spatial lag model. To do this, use the function
<code>impacts()</code>. You need to include the lag model object, the
spatial weights matrix, and the number of Monte Carlo simulations to
obtain simulated distributions of the impacts (this is used primarily
for getting the standard errors for statistical inference).</p>
<pre class="r"><code>fit.lag.effects &lt;- impacts(fit.lag, listw = nycw, R = 999)
fit.lag.effects</code></pre>
<pre><code>## Impact measures (lag, exact):
##                   Direct       Indirect          Total
## pblk       0.04856330681  0.08892198731  0.13748529412
## phisp      0.07620920998  0.13954310050  0.21575231049
## medincome -0.00001700018 -0.00003112824 -0.00004812842
## totp      -0.00002845456 -0.00005210180 -0.00008055636
## p65old     0.22563896431  0.41315689640  0.63879586071</code></pre>
<p>To get the standard errors, you use the <code>summary()</code>
function and ask it to report the test statistic (<em>Z</em>) and the
associated p-values.</p>
<pre class="r"><code>summary(fit.lag.effects, zstats = TRUE, short = TRUE)</code></pre>
<pre><code>## Impact measures (lag, exact):
##                   Direct       Indirect          Total
## pblk       0.04856330681  0.08892198731  0.13748529412
## phisp      0.07620920998  0.13954310050  0.21575231049
## medincome -0.00001700018 -0.00003112824 -0.00004812842
## totp      -0.00002845456 -0.00005210180 -0.00008055636
## p65old     0.22563896431  0.41315689640  0.63879586071
## ========================================================
## Simulation results ( variance matrix):
## ========================================================
## Simulated standard errors
##                 Direct      Indirect         Total
## pblk      0.0152786536 0.03225807833 0.04529713888
## phisp     0.0233953446 0.04793485395 0.06787789732
## medincome 0.0000130416 0.00002586462 0.00003848806
## totp      0.0000133995 0.00002810820 0.00004057923
## p65old    0.0687539846 0.15669132582 0.21562701936
## 
## Simulated z-values:
##              Direct  Indirect     Total
## pblk       3.211151  2.808731  3.083337
## phisp      3.261228  2.933746  3.195830
## medincome -1.273383 -1.194494 -1.234203
## totp      -2.099306 -1.869408 -1.988095
## p65old     3.368093  2.753414  3.074781
## 
## Simulated p-values:
##           Direct    Indirect  Total    
## pblk      0.0013220 0.0049737 0.0020469
## phisp     0.0011093 0.0033490 0.0013943
## medincome 0.2028822 0.2322848 0.2171272
## totp      0.0357900 0.0615660 0.0468012
## p65old    0.0007569 0.0058977 0.0021066</code></pre>
<p><br></p>
<p class="comment">
<strong>Question 4</strong>: In your own words, interpret the direct and
indirect effects of <em>pblk</em> based on the results presented above.
</p>
<p><br></p>
<div style="margin-bottom:25px;">

</div>
</div>
<div id="spatial-error-model" class="section level2">
<h2><strong>Spatial error model</strong></h2>
<p><br />
</p>
<p>The spatial error model (SEM) incorporates spatial dependence in the
errors. If there is a spatial error process going on and we fit an OLS
model our coefficients will be unbiased but inefficient. That is, the
coefficient size and sign are asymptotically correct but its standard
errors are underestimated.</p>
<p>We can estimate a spatial error model in R using the command
<code>errorsarlm()</code> also in the <strong>spatialreg</strong>
package.</p>
<pre class="r"><code>fit.err&lt;-errorsarlm(covidrate ~  pblk + phisp +  medincome +totp + p65old, 
                    data = zctanyc, 
                    listw = nycw, 
                    zero.policy=TRUE) </code></pre>
<p>And the Moran’s I of the residuals</p>
<pre class="r"><code>moran.mc(resid(fit.err), nycw, nsim=999, zero.policy=TRUE)</code></pre>
<pre><code>## 
##  Monte-Carlo simulation of Moran I
## 
## data:  resid(fit.err) 
## weights: nycw  
## number of simulations + 1: 1000 
## 
## statistic = -0.04723, observed rank = 220, p-value = 0.78
## alternative hypothesis: greater</code></pre>
<p>Are the residuals spatially autocorrelated?</p>
<p>A summary of the model</p>
<pre class="r"><code>summary(fit.err)</code></pre>
<pre><code>## 
## Call:errorsarlm(formula = covidrate ~ pblk + phisp + medincome + totp + 
##     p65old, data = zctanyc, listw = nycw, zero.policy = TRUE)
## 
## Residuals:
##     Min      1Q  Median      3Q     Max 
## -7.2334 -1.9737 -0.3498  1.6442 13.4324 
## 
## Type: error 
## Regions with no neighbours included:
##  59 
## Coefficients: (asymptotic standard errors) 
##                 Estimate   Std. Error z value    Pr(&gt;|z|)
## (Intercept) 12.226926402  2.689463340  4.5462 0.000005461
## pblk         0.061604532  0.022419247  2.7478    0.005999
## phisp        0.122124864  0.029625877  4.1222 0.000037521
## medincome   -0.000019168  0.000014531 -1.3191    0.187120
## totp        -0.000020288  0.000011160 -1.8180    0.069068
## p65old       0.188907339  0.070122942  2.6939    0.007061
## 
## Lambda: 0.78837, LR test value: 136.64, p-value: &lt; 0.000000000000000222
## Asymptotic standard error: 0.042485
##     z-value: 18.556, p-value: &lt; 0.000000000000000222
## Wald statistic: 344.34, p-value: &lt; 0.000000000000000222
## 
## Log likelihood: -480.8819 for error model
## ML residual variance (sigma squared): 10.804, (sigma: 3.287)
## Number of observations: 177 
## Number of parameters estimated: 8 
## AIC: NA (not available for weighted model), (AIC for lm: 1112.4)</code></pre>
<p>The presentation of results are similar to that of the spatial lag.
But, instead of Rho, you are shown Lambda.</p>
<p><br></p>
<p class="comment">
<strong>Question 5</strong>: What is the interpretation of the
coefficient on <em>medincome</em> in the Spatial Error model? Explain
the difference in this interpretation to the interpretations for the
<em>medincome</em> coefficient produced by <code>lm()</code> in the OLS
model and <code>lagsarlm()</code> in the Spatial Lag model.
</p>
<p><br></p>
<div style="margin-bottom:25px;">

</div>
</div>
<div id="model-selection" class="section level2">
<h2><strong>Model Selection</strong></h2>
<p><br />
</p>
<p>We’ve run all three models, so the question then is which one to
choose: OLS, Spatial lag, or Spatial error? You can make this decision a
couple of ways. First, rely on comparisons of goodness of fit measures,
specifically the Akaike Information Criterion (AIC) and Bayesian
Information Criterion (BIC). Second, run formal hypothesis tests
comparing the models using Lagrange Multiplier tests.</p>
<div style="margin-bottom:25px;">

</div>
<div id="aic-and-bic" class="section level3">
<h3><strong>AIC and BIC</strong></h3>
<p><br />
</p>
<p>AIC and BIC rely on the log likelihood, which captures the
probability of the observed data given the model parameters. The lower
the AIC and BIC, the better model fit. Rather than rely on one vs
another, in general, it might be best to use AIC and BIC together in
model selection.</p>
<p>The <code>lagsarlm()</code> and <code>errorsarlm()</code> already
provide the AIC at the bottom of the summary output. But, you can call
it up by using the <code>AIC()</code> function. To get the BIC, use the
function <code>BIC()</code></p>
<p><br></p>
<p class="comment">
<strong>Question 6</strong>: Run the AIC and BIC for the OLS, SLM and
SEM models. Based on the AIC and BIC, which model would you choose and
why?
</p>
<div style="margin-bottom:25px;">

</div>
</div>
<div id="lagrange-multiplier-tests" class="section level3">
<h3><strong>Lagrange Multiplier Tests</strong></h3>
<p><br />
</p>
<p>A popular set of tests to determine the appropriate model was
proposed by <a
href="https://onlinelibrary.wiley.com/doi/abs/10.1111/j.1538-4632.1988.tb00159.x">Anselin
(1988)</a> (also see <a
href="https://www.sciencedirect.com/science/article/abs/pii/0166046295021116">Anselin
et al. 1996</a>), These tests are elegantly known as Lagrange Multiplier
(LM) tests and are discussed in the Handout. The null in these tests is
the OLS model. A test showing statistical significance rejects this
null.</p>
<p>The LM test uses the likelihood of the models being compared to
assess their fit. The likelihood is the probability the data given the
parameter estimates. The goal of a model is to find values for the
regression coefficients that maximize the likelihood, that is, to find
the set of parameter estimates that make the data most likely. The
Lagrange multiplier compares the likelihood of two models. In our case,
you are comparing whether the likelihood of a spatial model
(alternative) is statistically higher than that of an OLS (null). We’ll
use <span
class="math inline"><em>L</em><em>M</em><sub><em>l</em><em>a</em><em>g</em></sub></span>
to refer to a test of SLM vs. OLS and <span
class="math inline"><em>L</em><em>M</em><sub><em>e</em><em>r</em><em>r</em></sub></span>
to refer to a test of SEM vs. OLS.</p>
<p>The issue with the Lagrange Multiplier test is when you are comparing
the OLS to the spatial lag, you are not taking into account the presence
of the spatial error (and vice versa). In other words, a test of the SLM
against the null of an OLS may be rejecting the null in the presence of
the spatial error model. Recognizing this issue, <a
href="https://www.sciencedirect.com/science/article/abs/pii/0166046295021116">Anselin
et al. (1996)</a> make an asymptotic adjustment to the LM test to
correct for this. They formulate robust versions of the LM tests -
robust to the presence of the other spatial model.</p>
<p>We will not go into great detail on how these LM tests are derived.
If you are interested in these details, I suggest reading <a
href="https://onlinelibrary.wiley.com/doi/abs/10.1111/j.1538-4632.1988.tb00159.x">Anselin
(1988)</a>, which formulates the non robust LM tests, and <a
href="https://www.sciencedirect.com/science/article/abs/pii/0166046295021116">Anselin
et al. (1996)</a>, which constructs the robust LM tests.</p>
<p>We’re still not quite there in terms of how to choose between the
three different models. The LM test tests between the OLS and SLM and
the OLS and SEM, but cannot directly compare SLM and SEM. The SLM and
SEM are non-nested models (the OLS is a nested model of SLM - take out
<span class="math inline"><em>W</em><em>y</em></span> and you get the
OLS), and thus statistical tests like the LM (and others using the
likelihood and other fit statistics) cannot make direct comparisons.
However, Anselin (1996) formulated a set of decision steps using the LM
tests to decide between SLM and SEM (and OLS). The steps are outlined in
this week’s handout.</p>
<p>To run the LM tests in R, use the <code>lm.LMtests()</code> command
in the <strong>spatialreg</strong> package. The argument
<code>test = "all"</code> runs all the tests. You should look at
<em>LMerr</em> (Spatial Error), <em>LMlag</em> (Spatial Lag),
<em>RLMerr</em> (Robust Spatial Error) and <em>RLMlag</em> (Robust
Spatial Lag).</p>
<pre class="r"><code>lm.LMtests(fit.ols, listw = nycw, 
           test = c(&quot;LMerr&quot;, &quot;LMlag&quot;, &quot;RLMerr&quot;, &quot;RLMlag&quot;),
           zero.policy=TRUE)</code></pre>
<pre><code>## 
##  Lagrange multiplier diagnostics for spatial dependence
## 
## data:  
## model: lm(formula = covidrate ~ pblk + phisp + medincome + totp +
## p65old, data = zctanyc)
## weights: nycw
## 
## LMerr = 139.96, df = 1, p-value &lt; 0.00000000000000022
## 
## 
##  Lagrange multiplier diagnostics for spatial dependence
## 
## data:  
## model: lm(formula = covidrate ~ pblk + phisp + medincome + totp +
## p65old, data = zctanyc)
## weights: nycw
## 
## LMlag = 137.42, df = 1, p-value &lt; 0.00000000000000022
## 
## 
##  Lagrange multiplier diagnostics for spatial dependence
## 
## data:  
## model: lm(formula = covidrate ~ pblk + phisp + medincome + totp +
## p65old, data = zctanyc)
## weights: nycw
## 
## RLMerr = 11.124, df = 1, p-value = 0.0008521
## 
## 
##  Lagrange multiplier diagnostics for spatial dependence
## 
## data:  
## model: lm(formula = covidrate ~ pblk + phisp + medincome + totp +
## p65old, data = zctanyc)
## weights: nycw
## 
## RLMlag = 8.5867, df = 1, p-value = 0.003386</code></pre>
<p><br></p>
<p class="comment">
<strong>Question 7</strong>: Using the steps outlined in the Handout,
specify which model is “best” based on the LM test results? Explain why.
</p>
<p><br></p>
<p>Although it is important to run these tests, whether SLM or SEM is
most appropriate is really a prior theoretical question, which must be
considered relative to the goals of a specific research question. If we
expect to see, or are interested in estimating, spatial feedback, then
SLM would be a more appropriate model. For example, if you are
interested in understanding whether COVID-19 diffuses across
neighborhood borders, an SLM is the most appropriate model. If you are
interested in understanding whether crime rates in a neighborhood are
influenced by the crime rates in nearby neighbors, run SLM. If you are
interested in simply controlling for spatial dependency as a nuisance,
run an SEM.</p>
<hr />
<p><a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc/4.0/88x31.png" /></a><br />This
work is licensed under a
<a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/">Creative
Commons Attribution-NonCommercial 4.0 International License</a>.</p>
<p>Website created and maintained by <a
href="https://nbrazil.faculty.ucdavis.edu/">Noli Brazil</a></p>
</div>
</div>



</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->
<script>
$(document).ready(function () {
  window.initializeCodeFolding("show" === "show");
});
</script>

<script>
$(document).ready(function ()  {

    // temporarily add toc-ignore selector to headers for the consistency with Pandoc
    $('.unlisted.unnumbered').addClass('toc-ignore')

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3,h4",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_');
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>


</body>
</html>
